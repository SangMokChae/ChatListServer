<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>ğŸ‘¥ ì¹œêµ¬ ëª©ë¡</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
		/* ë©”ë‰´ ìœ„ì¹˜ ì¡°ì • */
		#dropdownMenu {
			display: none;
		}
		#dropdownMenu.show {
			display: block;
		}
	</style>
</head>
<body class="bg-gray-100 min-h-screen font-sans relative">

<!-- í† ê¸€ ë²„íŠ¼ (ê¸°ë³¸ì€ ë³´ì„) -->
<button id="sidebarToggle" class="fixed top-4 left-4 z-50 bg-white p-2 rounded-full shadow-md">
	<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
			 viewBox="0 0 24 24" stroke="currentColor">
		<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
					d="M4 6h16M4 12h16M4 18h16"/>
	</svg>
</button>

<!-- ì‚¬ì´ë“œë°” + ì™¸ë¶€ í´ë¦­ ê°ì§€ë¥¼ ìœ„í•œ wrapper -->
<div id="sidebarWrapper" class="fixed inset-0 z-40 hidden">
	<!-- í´ë¦­ ì°¨ë‹¨ìš© ë°°ê²½ (ë‹«ê¸° íŠ¸ë¦¬ê±°) -->
	<div id="sidebarOverlay" class="absolute inset-0 bg-black opacity-10"></div>
	
	<!-- ì‹¤ì œ ì‚¬ì´ë“œë°” -->
	<div id="sidebar" class="relative h-full w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 flex flex-col">
		<div class="p-4 border-b font-semibold text-xl">ğŸ‘¤ [[${userId}]]</div>
		<nav class="flex-1 flex flex-col p-4 gap-2">
			<a href="/view/friendListView" class="p-2 hover:bg-gray-100 rounded-lg flex items-center gap-2">
				ğŸ‘¥ ì¹œêµ¬ ëª©ë¡
			</a>
			<a href="/view/chatListView" class="p-2 hover:bg-gray-100 rounded-lg flex items-center gap-2">
				ğŸ’¬ ì±„íŒ… ëª©ë¡
			</a>
		</nav>
		<a href="/logout" class="mt-auto p-4 border-t text-red-600 hover:bg-red-100 flex items-center gap-2">
			ğŸšª ë¡œê·¸ì•„ì›ƒ
		</a>
	</div>
</div>

<div class="max-w-xl mx-auto p-6">
	<h2 class="text-2xl font-bold mb-6 text-center">ğŸ‘¥ ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸</h2>
	<div id="chat-list" class="space-y-3"></div>
</div>

<!-- âœ… ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ -->
<div class="p-4 space-y-4 max-w-md mx-auto">
	<div th:each="friend : ${friendList}"
			 class="bg-white p-4 rounded-xl shadow hover:bg-gray-50 transition cursor-pointer"
			 th:attr="data-id=${friend.friendId}"
			 ondblclick="openChatWithFriend(this.getAttribute('data-id'))">
		<div class="text-lg font-semibold" th:text="${friend.friendNickname}">ë‹‰ë„¤ì„</div>
		<div class="text-sm text-gray-500" th:text="'ID: ' + ${friend.friendId}">ì•„ì´ë””</div>
		<div class="text-xs text-gray-400 mt-1" th:text="${friend.status}">ìƒíƒœ</div>
	</div>
</div>

<script th:inline="javascript">
	const userId = [[${userId}]];

	// âœ… ì¹œêµ¬ ë”ë¸” í´ë¦­ ì‹œ ì±„íŒ…ë°© ì—´ê¸°
	function openChatWithFriend(friendId) {
		fetch('/api/friends/chatRoom', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ 'friendId' : friendId })
		})
		.then(res => {
			if (!res.ok) throw new Error("ì±„íŒ…ë°© ìš”ì²­ ì‹¤íŒ¨");
			return res.json();
		})
		.then(data => {
			const form = document.createElement('form');
			form.method = 'POST';
			form.action = '/view/chatView'
			form.enctype = 'application/x-www-form-urlencoded';
			
			const input = document.createElement('input');
			input.type = 'hidden';
			input.name = 'roomId';
			input.value = `${data.roomId}`;
			form.appendChild(input);
			
			// ë°© ìƒˆë¡œ ìƒì„± í• ë•Œ inUserIds ì„¤ì •
			const input2 = document.createElement('input');
			input2.type = 'hidden';
			input2.name = 'participants';
			let inUserIdsArr = [userId, friendId];
			input2.value = inUserIdsArr
			form.appendChild(input2);
			
			document.body.appendChild(form);
			form.submit();
		})
		.catch(err => {
			alert("ì±„íŒ…ë°© ì´ë™ ì‹¤íŒ¨: " + err.message);
		});
	}
	
	// list toggle
	const sidebarToggle = document.getElementById("sidebarToggle");
	const sidebarWrapper = document.getElementById("sidebarWrapper");
	const sidebar = document.getElementById("sidebar");
	const sidebarOverlay = document.getElementById("sidebarOverlay");

	// ì‚¬ì´ë“œë°” ì—´ê¸°
	sidebarToggle.addEventListener("click", () => {
		sidebarWrapper.classList.remove("hidden");
		sidebar.classList.remove("-translate-x-full");
		sidebarToggle.classList.add("hidden");
	});

	// ì‚¬ì´ë“œë°” ë‹«ê¸° (ë°°ê²½ í´ë¦­)
	sidebarOverlay.addEventListener("click", () => {
		sidebar.classList.add("-translate-x-full");
		setTimeout(() => {
			sidebarWrapper.classList.add("hidden");
			sidebarToggle.classList.remove("hidden");
		}, 300); // transition durationê³¼ ì¼ì¹˜
	});
</script>

</body>
</html>