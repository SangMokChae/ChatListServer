<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>ğŸ‘¥ ì¹œêµ¬ ëª©ë¡</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
		/* ë©”ë‰´ ìœ„ì¹˜ ì¡°ì • */
		#dropdownMenu {
			display: none;
		}
		#dropdownMenu.show {
			display: block;
		}
	</style>
</head>
<body class="bg-gray-100 min-h-screen font-sans relative">

<!-- âœ… ìƒë‹¨ë°” -->
<div class="bg-white shadow p-4 flex justify-between items-center">
	<h1 class="text-xl font-bold">ì¹œêµ¬ ëª©ë¡</h1>
	
	<!-- âœ… ìš°ì¸¡ ë©”ë‰´ ë²„íŠ¼ -->
	<div class="relative">
		<button id="menuButton" class="focus:outline-none">
			<!-- Heroicons "bars-3" -->
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
					 stroke="currentColor" class="w-6 h-6">
				<path stroke-linecap="round" stroke-linejoin="round"
							d="M3.75 5.25h16.5m-16.5 6h16.5m-16.5 6h16.5"/>
			</svg>
		</button>
		
		<!-- âœ… ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
		<div id="dropdownMenu"
				 class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-md shadow-lg z-10">
			<a href="/view/friendSearchView"
				 class="block px-4 py-2 text-gray-700 hover:bg-gray-100">ğŸ” ì¹œêµ¬ ì°¾ê¸°</a>
			<a href="/logout" class="block px-4 py-2 text-red-600 hover:bg-red-100">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
		</div>
	</div>
</div>

<!-- âœ… ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ -->
<div class="p-4 space-y-4 max-w-md mx-auto">
	<div th:each="friend : ${friendList}"
			 class="bg-white p-4 rounded-xl shadow hover:bg-gray-50 transition cursor-pointer"
			 th:attr="data-id=${friend.friendId}"
			 ondblclick="openChatWithFriend(this.getAttribute('data-id'))">
		<div class="text-lg font-semibold" th:text="${friend.friendNickname}">ë‹‰ë„¤ì„</div>
		<div class="text-sm text-gray-500" th:text="'ID: ' + ${friend.friendId}">ì•„ì´ë””</div>
		<div class="text-xs text-gray-400 mt-1" th:text="${friend.status}">ìƒíƒœ</div>
	</div>
</div>

<!-- âœ… ë©”ë‰´ í† ê¸€ ìŠ¤í¬ë¦½íŠ¸ + ì±„íŒ…ë°© ì´ë™ ë¡œì§ -->
<script th:inline="javascript">
	const userId = [[${userId}]];
	
	document.getElementById('menuButton').addEventListener('click', function () {
		const menu = document.getElementById('dropdownMenu');
		menu.classList.toggle('show');
	});

	// í´ë¦­ ì™¸ë¶€ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
	window.addEventListener('click', function (e) {
		const menu = document.getElementById('dropdownMenu');
		const button = document.getElementById('menuButton');
		if (!button.contains(e.target) && !menu.contains(e.target)) {
			menu.classList.remove('show');
		}
	});

	// âœ… ì¹œêµ¬ ë”ë¸” í´ë¦­ ì‹œ ì±„íŒ…ë°© ì—´ê¸°
	function openChatWithFriend(friendId) {
		fetch('/api/friends/chatRoom', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ 'friendId' : friendId })
		})
		.then(res => {
			if (!res.ok) throw new Error("ì±„íŒ…ë°© ìš”ì²­ ì‹¤íŒ¨");
			return res.json();
		})
		.then(data => {
			const form = document.createElement('form');
			form.method = 'POST';
			form.action = '/view/chatView'
			form.enctype = 'application/x-www-form-urlencoded';
			
			const input = document.createElement('input');
			input.type = 'hidden';
			input.name = 'roomId';
			input.value = `${data.roomId}`;
			form.appendChild(input);
			
			// ë°© ìƒˆë¡œ ìƒì„± í• ë•Œ inUserIds ì„¤ì •
			const input2 = document.createElement('input');
			input2.type = 'hidden';
			input2.name = 'inUserIds';
			let inUserIdsArr = [userId, friendId];
			input2.value = inUserIdsArr
			form.appendChild(input2);
			
			document.body.appendChild(form);
			form.submit();
		})
		.catch(err => {
			alert("ì±„íŒ…ë°© ì´ë™ ì‹¤íŒ¨: " + err.message);
		});
	}
</script>

</body>
</html>