<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>Chat List View</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script th:src="@{https://cdn.tailwindcss.com}"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans relative">
<!-- 로그아웃 버튼 -->
<a href="/logout"
	 class="absolute top-4 right-4 px-3 py-2 rounded-xl hover:bg-red-200 transition-all flex items-center gap-2">
	<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30" height="30">
		<path fill-rule="evenodd" d="M16.5 3.75a1.5 1.5 0 0 1 1.5 1.5v13.5a1.5 1.5 0 0 1-1.5 1.5h-6a1.5 1.5 0 0 1-1.5-1.5V15a.75.75 0 0 0-1.5 0v3.75a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3V5.25a3 3 0 0 0-3-3h-6a3 3 0 0 0-3 3V9A.75.75 0 1 0 9 9V5.25a1.5 1.5 0 0 1 1.5-1.5h6ZM5.78 8.47a.75.75 0 0 0-1.06 0l-3 3a.75.75 0 0 0 0 1.06l3 3a.75.75 0 0 0 1.06-1.06l-1.72-1.72H15a.75.75 0 0 0 0-1.5H4.06l1.72-1.72a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" />
	</svg>
</a>

<div class="max-w-xl mx-auto p-6">
	<h2 class="text-2xl font-bold mb-6 text-center">💬 채팅방 목록</h2>
	<div id="chat-list" class="space-y-3"></div>
</div>

<script th:inline="javascript">
	const userId = [[${userId}]];
	const socket = new WebSocket(`ws://${location.hostname}:8082/ws/chatList/${userId}`);
	const chatListEl = document.getElementById("chat-list");
	const chatRooms = new Map();

	socket.onmessage = function (event) {
		const incoming = JSON.parse(event.data);

		// 누락된 필드 기본값 설정
		if (!incoming.userIds || incoming.userIds.length === 0) {
			incoming.userIds = [userId];  // 또는 서버에서 따로 내려줄 defaultUserIds
		}
		if (!incoming.roomName) {
			incoming.roomName = incoming.userIds.filter(e => e !== userId).join(',');
		}
		
		chatRooms.set(incoming.roomId, {
			...chatRooms.get(incoming.roomId),
			...incoming
		});

		const sorted = Array.from(chatRooms.values())
			.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));

		renderChatList(sorted);
	};

	function renderChatList(rooms) {
		chatListEl.innerHTML = "";

		rooms.forEach(room => {
			const div = document.createElement("div");
			let roomName = null;
			
			if(room.roomName != null && room.roomName != "") {
				roomName = room.roomName;
			} else {
				roomName = room.userIds.filter(e => e != userId).join(",");
			}
			
			// roomName이 null이 아니면 roomName으로
			// roomName이 없으면 room.userIds 를 Set으로 변형한뒤, 본인을 제외하고 보여주기
			div.innerHTML = `
				<a href="#" data="${encodeURIComponent(room.roomId)}"
					 class="block border border-gray-300 p-4 rounded-xl hover:bg-gray-50 transition-all"
					 onclick="moveChatView(this)"
				 >
					<div class="font-semibold text-lg">${roomName}</div>
					<div class="text-sm text-gray-600">${room.lastMessage || "대화 없음"}</div>
					<div class="text-xs text-gray-400 mt-1">${room.lastMessageTime || "-"}</div>
					<input type="hidden" id="inUserIds" value="${room.userIds}" />
				</a>
			`;
			chatListEl.appendChild(div);
		});
	}
	
	const moveChatView = (e) => {
		const form = document.createElement('form');
		form.method = 'POST';
		form.action = '/view/chatView'
		form.enctype = 'application/x-www-form-urlencoded';
		
		const input = document.createElement('input');
		input.type = 'hidden';
		input.name = 'roomId';
		input.value = e.getAttribute('data');
		form.appendChild(input);
		
		const input2 = document.createElement('input');
		input2.type = 'hidden';
		input2.name = 'inUserIds';
		input2.value = e.querySelector("#inUserIds").value;
		form.appendChild(input2);
		
		document.body.appendChild(form);
		form.submit();
	}
</script>
</body>
</html>
